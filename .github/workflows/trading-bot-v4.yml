name: Kraken Trading Bot V4 - Advanced AI

on:
  # AutomÃ¡tico cada 15 minutos
  schedule:
    - cron: '*/15 * * * *'
  
  # Manual con opciones
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Modo SimulaciÃ³n (true) o Real (false)'
        required: false
        default: 'false'
      use_sentiment:
        description: 'Usar Sentiment Analysis'
        required: false
        default: 'true'
      use_onchain:
        description: 'Usar On-Chain Metrics'
        required: false
        default: 'true'
      use_ensemble:
        description: 'Usar Multi-Strategy Ensemble'
        required: false
        default: 'true'
      use_rl:
        description: 'Usar RL Position Sizing'
        required: false
        default: 'true'

jobs:
  trade:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: ğŸ”¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Instalar dependencias
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    # âœ… CORREGIDO: Cargar RL state con mejor manejo
    - name: ğŸ“‚ Cargar RL State
      id: load-rl
      continue-on-error: true
      uses: actions/cache@v4
      with:
        path: rl_state.json
        key: rl-state-${{ github.run_number }}
        restore-keys: |
          rl-state-
    
    # âœ… NUEVO: Crear archivo vacÃ­o si no existe
    - name: ğŸ“ Inicializar RL State si no existe
      run: |
        if [ ! -f rl_state.json ]; then
          echo '{"q_table": {}, "metadata": {"created": "init", "num_states": 0}}' > rl_state.json
          echo "âœ“ RL state inicializado"
        else
          echo "âœ“ RL state cargado desde cache"
        fi
    
    - name: ğŸš€ Ejecutar Bot V4 (Advanced AI)
      env:
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        #                    APIS
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
        KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
        CRYPTOCOMPARE_API_KEY: ${{ secrets.CRYPTOCOMPARE_API_KEY }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        #            SENTIMENT ANALYSIS (V4)
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        USE_SENTIMENT_ANALYSIS: ${{ github.event.inputs.use_sentiment || 'true' }}
        MIN_SENTIMENT_CONFIDENCE: '0.5'
        
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        #            ON-CHAIN ANALYSIS (V4)
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        USE_ONCHAIN_ANALYSIS: ${{ github.event.inputs.use_onchain || 'true' }}
        MIN_ONCHAIN_STRENGTH: '0.5'
        
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        #         MULTI-STRATEGY ENSEMBLE (V4)
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        USE_ENSEMBLE_SYSTEM: ${{ github.event.inputs.use_ensemble || 'true' }}
        MIN_ENSEMBLE_CONSENSUS: '0.6'     # 60% estrategias deben coincidir
        MIN_ENSEMBLE_CONFIDENCE: '0.6'    # Confianza mÃ­nima del ensemble
        
        # Pesos de estrategias (deben sumar ~1.0)
        WEIGHT_SWING: '0.30'
        WEIGHT_MOMENTUM: '0.25'
        WEIGHT_MEAN_REVERSION: '0.25'
        WEIGHT_TREND_FOLLOWING: '0.20'
        
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        #       REINFORCEMENT LEARNING (V4)
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        USE_RL_POSITION_SIZING: ${{ github.event.inputs.use_rl || 'true' }}
        RL_LEARNING_RATE: '0.1'           # Alpha
        RL_DISCOUNT_FACTOR: '0.95'        # Gamma
        RL_EPSILON: '0.1'                 # ExploraciÃ³n (10%)
        RL_STATE_FILE: 'rl_state.json'
        
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        #            MULTI-ASSET TRADING (v4)
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        MAX_CORRELATION: '0.7'
        MAX_POSITIONS: '3'
        
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        #            RISK MANAGEMENT
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        LEVERAGE: '3'                     # Base leverage (RL puede ajustar)
        MIN_BALANCE: '1.0'
        
        STOP_LOSS_PCT: '4.0'              # Base (regime puede ajustar)
        TAKE_PROFIT_PCT: '8.0'
        TRAILING_STOP_PCT: '2.5'
        MIN_PROFIT_FOR_TRAILING: '3.0'
        
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        #            STRATEGY SETTINGS (v4)
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        LOOKBACK_PERIOD: '180d'
        CANDLE_INTERVAL: '1h'
        USE_VOLUME_FILTER: 'true'
        REGIME_LOOKBACK: '30'
        
        # ML Validation (v4)
        USE_ML_VALIDATION: 'true'
        ML_CONFIDENCE_THRESHOLD: '0.6'
        
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        #            MODE
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
      
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸš€ KRAKEN TRADING BOT V4 - ADVANCED AI SYSTEM"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ“… $(date)"
        echo "ğŸ¯ Mode: $([ "$DRY_RUN" = "true" ] && echo "SIMULATION" || echo "REAL TRADING")"
        echo ""
        echo "ğŸ¤– AI Features V4:"
        echo "   Sentiment Analysis: $USE_SENTIMENT_ANALYSIS"
        echo "   On-Chain Metrics: $USE_ONCHAIN_ANALYSIS"
        echo "   Ensemble System: $USE_ENSEMBLE_SYSTEM"
        echo "   RL Position Sizing: $USE_RL_POSITION_SIZING"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        
        # Ejecutar bot V4
        python kraken_bot_v4_advanced.py
    
    # âœ… CORREGIDO: Guardar RL state mejorado
    - name: ğŸ’¾ Guardar RL State
      if: always()
      continue-on-error: true
      run: |
        if [ -f rl_state.json ]; then
          echo "âœ“ RL state existe, serÃ¡ guardado en cache"
          ls -lh rl_state.json
        else
          echo "âš ï¸ RL state no encontrado, creando archivo vacÃ­o"
          echo '{"q_table": {}, "metadata": {}}' > rl_state.json
        fi
    
    - name: ğŸ“¤ Cache RL State
      if: always()
      uses: actions/cache@v4
      with:
        path: rl_state.json
        key: rl-state-${{ github.run_number }}
    
    # Subir logs como artifacts (para debugging)
    - name: ğŸ“¤ Subir logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: trading-logs-${{ github.run_number }}
        path: |
          *.log
          rl_state.json
        retention-days: 7
    
    - name: âœ… Completado
      if: success()
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "âœ… Bot V4 ejecutado exitosamente - $(date)"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    - name: âŒ Error
      if: failure()
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "âŒ Error en ejecuciÃ³n - $(date)"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        exit 1
