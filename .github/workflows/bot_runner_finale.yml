name: Controllo Bot Larry Finale

on:
  workflow_dispatch:

jobs:
  run-trading-bot:
    runs-on: self-hosted
    steps:
      - name: Scarica i file
        uses: actions/checkout@v4
      - name: Lista File Reale
        run: |
          python -c "import os; print('--- ELENCO FILE NELLA CARTELLA ---'); print(os.listdir('.'))"

      - name: Creazione Configurazione e Avvio
        shell: powershell
        run: |
          # 1. Definiamo il contenuto
          $content = @(
            "KRAKEN_API_KEY=${{ secrets.KRAKEN_API_KEY }}",
            "KRAKEN_SECRET_KEY=${{ secrets.KRAKEN_API_SECRET }}",
            "TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}",
            "TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}",
            "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}"
          )

          # 2. Scriviamo il file proprio qui
          $path = Join-Path (Get-Location) ".env"
          $utf8NoBom = New-Object System.Text.UTF8Encoding $false
          [System.IO.File]::WriteAllLines($path, $content, $utf8NoBom)

          # 3. Controllo veloce: il file esiste ora?
          if (Test-Path $path) { 
              Write-Host "✅ File .env creato correttamente in: $path"
              # Mostriamo le prime lettere di una chiave per sicurezza (opzionale)
              Get-Content $path | Select-Object -First 1
          } else { 
              Write-Host "❌ Errore: Impossibile creare il file .env" 
          }

          # 4. Lanciamo il bot
          python -u start_live_simulation.py

          - name: Diagnosi Credenziali
            run: |
              python -c "
              import os
              from dotenv import load_dotenv
          # 1. Vediamo dove siamo
          print(f'Cartella di lavoro: {os.getcwd()}')

          # 2. Proviamo a caricare il file .env
          check_load = load_dotenv()
          print(f'Esito load_dotenv: {check_load}')

          # 3. Verifichiamo se le chiavi Kraken sono caricate
          api_key = os.getenv('KRAKEN_API_KEY')
          api_secret = os.getenv('KRAKEN_SECRET_KEY') # o KRAKEN_API_SECRET

          print(f'KRAKEN_API_KEY trovata: {bool(api_key)}')
          print(f'KRAKEN_SECRET_KEY trovata: {bool(api_secret)}')
          "
