name: Kraken Trading Bot V4 - Advanced AI

on:
  # Automรกtico cada 15 minutos
  schedule:
    - cron: '*/15 * * * *'
  
  # Manual con opciones
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Modo Simulaciรณn (true) o Real (false)'
        required: false
        default: 'true'
      use_sentiment:
        description: 'Usar Sentiment Analysis'
        required: false
        default: 'true'
      use_onchain:
        description: 'Usar On-Chain Metrics'
        required: false
        default: 'true'
      use_ensemble:
        description: 'Usar Multi-Strategy Ensemble'
        required: false
        default: 'true'
      use_rl:
        description: 'Usar RL Position Sizing'
        required: false
        default: 'true'

jobs:
  trade:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: ๐ฅ Checkout cรณdigo
      uses: actions/checkout@v4
    
    - name: ๐ Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ๐ฆ Instalar dependencias
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    # Cargar RL state si existe (para persistencia)
    - name: ๐ Cargar RL State
      id: load-rl
      continue-on-error: true
      uses: actions/cache@v3
      with:
        path: rl_state.json
        key: rl-state-${{ github.run_number }}
        restore-keys: |
          rl-state-
    
    - name: ๐ Ejecutar Bot V4 (Advanced AI)
      env:
        # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        #                    APIS
        # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
        KRAKEN_API_SECRET: ${{ secrets.KRAKEN_API_SECRET }}
        CRYPTOCOMPARE_API_KEY: ${{ secrets.CRYPTOCOMPARE_API_KEY }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        
        # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        #            SENTIMENT ANALYSIS (NUEVO)
        # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        USE_SENTIMENT_ANALYSIS: ${{ github.event.inputs.use_sentiment || 'true' }}
        MIN_SENTIMENT_CONFIDENCE: '0.5'
        SENTIMENT_CACHE_DURATION: '300'  # 5 minutos
        
        # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        #            ON-CHAIN ANALYSIS (NUEVO)
        # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        USE_ONCHAIN_ANALYSIS: ${{ github.event.inputs.use_onchain || 'true' }}
        MIN_ONCHAIN_STRENGTH: '0.5'
        ONCHAIN_CACHE_DURATION: '600'  # 10 minutos
        
        # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        #         MULTI-STRATEGY ENSEMBLE (NUEVO)
        # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        USE_ENSEMBLE_SYSTEM: ${{ github.event.inputs.use_ensemble || 'true' }}
        MIN_ENSEMBLE_CONSENSUS: '0.6'     # 60% estrategias deben coincidir
        MIN_ENSEMBLE_CONFIDENCE: '0.6'    # Confianza mรญnima del ensemble
        
        # Pesos de estrategias (deben sumar ~1.0)
        WEIGHT_SWING: '0.30'
        WEIGHT_MOMENTUM: '0.25'
        WEIGHT_MEAN_REVERSION: '0.25'
        WEIGHT_TREND_FOLLOWING: '0.20'
        
        # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        #       REINFORCEMENT LEARNING (NUEVO)
        # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        USE_RL_POSITION_SIZING: ${{ github.event.inputs.use_rl || 'true' }}
        RL_LEARNING_RATE: '0.1'           # Alpha
        RL_DISCOUNT_FACTOR: '0.95'        # Gamma
        RL_EPSILON: '0.1'                 # Exploraciรณn (10%)
        RL_STATE_FILE: 'rl_state.json'
        
        # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        #            MULTI-ASSET TRADING
        # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        MAX_CORRELATION: '0.7'
        MAX_POSITIONS: '3'
        
        # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        #            RISK MANAGEMENT
        # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        LEVERAGE: '3'                     # Base leverage (RL puede ajustar)
        MIN_BALANCE: '30.0'
        
        STOP_LOSS_PCT: '4.0'              # Base (regime puede ajustar)
        TAKE_PROFIT_PCT: '8.0'
        TRAILING_STOP_PCT: '2.5'
        MIN_PROFIT_FOR_TRAILING: '3.0'
        
        # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        #            STRATEGY SETTINGS
        # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        LOOKBACK_PERIOD: '180d'
        CANDLE_INTERVAL: '1h'
        USE_VOLUME_FILTER: 'true'
        REGIME_LOOKBACK: '30'
        
        # ML Validation (V3)
        USE_ML_VALIDATION: 'true'
        ML_CONFIDENCE_THRESHOLD: '0.6'
        
        # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        #            MODE
        # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        DRY_RUN: ${{ github.event.inputs.dry_run || 'true' }}
      
      run: |
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        echo "๐ KRAKEN TRADING BOT V4 - ADVANCED AI SYSTEM"
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        echo "๐ $(date)"
        echo "๐ฏ Mode: $([ "$DRY_RUN" = "true" ] && echo "SIMULATION" || echo "REAL TRADING")"
        echo ""
        echo "๐ค AI Features:"
        echo "   Sentiment Analysis: $USE_SENTIMENT_ANALYSIS"
        echo "   On-Chain Metrics: $USE_ONCHAIN_ANALYSIS"
        echo "   Ensemble System: $USE_ENSEMBLE_SYSTEM"
        echo "   RL Position Sizing: $USE_RL_POSITION_SIZING"
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        echo ""
        
        # Ejecutar bot V4
        python kraken_bot_v4_advanced.py
    
    # Guardar RL state actualizado
    - name: ๐พ Guardar RL State
      if: always()
      uses: actions/cache@v3
      with:
        path: rl_state.json
        key: rl-state-${{ github.run_number }}
    
    # Subir logs como artifacts
    - name: ๐ค Subir logs
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: trading-logs-${{ github.run_number }}
        path: |
          *.log
          rl_state.json
        retention-days: 7
    
    - name: โ Completado
      if: success()
      run: |
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        echo "โ Bot V4 ejecutado exitosamente - $(date)"
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    
    - name: โ Error
      if: failure()
      run: |
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        echo "โ Error en ejecuciรณn - $(date)"
        echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
        exit 1
