name: Controllo Bot Larry Finale

on:
  workflow_dispatch:

jobs:
  run-trading-bot:
    runs-on: self-hosted
    steps:
      - name: Scarica i file
        uses: actions/checkout@v4
      - name: Lista File Reale
        run: |
          python -c "import os; print('--- ELENCO FILE NELLA CARTELLA ---'); print(os.listdir('.'))"

      - name: Creazione file .env (Fix Codifica)
        shell: pwsh # Usa PowerShell Core se disponibile o forza la codifica
        run: |
          $content = @(
            "KRAKEN_API_KEY=${{ secrets.KRAKEN_API_KEY }}",
            "KRAKEN_SECRET_KEY=${{ secrets.KRAKEN_API_SECRET }}",
            "TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}",
            "TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}",
            "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}"
          )
          # Il segreto Ã¨ l'uso di UTF8 senza BOM
          [System.IO.File]::WriteAllLines("$(pwd)\.env", $content)

      - name: Esegui il Bot
        env:
          PYTHONIOENCODING: utf-8
        run: python -u start_live_simulation.py

      - name: Diagnosi Credenziali
        run: |
          python -c "
          import os
          from dotenv import load_dotenv

          # 1. Vediamo dove siamo
          print(f'Cartella di lavoro: {os.getcwd()}')

          # 2. Proviamo a caricare il file .env
          check_load = load_dotenv()
          print(f'Esito load_dotenv: {check_load}')

          # 3. Verifichiamo se le chiavi Kraken sono caricate
          api_key = os.getenv('KRAKEN_API_KEY')
          api_secret = os.getenv('KRAKEN_SECRET_KEY') # o KRAKEN_API_SECRET

          print(f'KRAKEN_API_KEY trovata: {bool(api_key)}')
          print(f'KRAKEN_SECRET_KEY trovata: {bool(api_secret)}')
          "
