name: Controllo Bot Larry Finale

on:
  workflow_dispatch:

jobs:
  run-trading-bot:
    runs-on: self-hosted
    timeout-minutes: 43200 # 30 giorni (massimo consentito spesso è 72h, ma proviamo max)
    steps:
      - name: Scarica i file
        uses: actions/checkout@v4

      # --- INIZIO BLOCCO GPG ---
      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}
          git_user_signingkey: true
          git_commit_gpgsign: true
      # --- FINE BLOCCO GPG ---

      - name: Configura Ambiente e Avvia Bot
        shell: powershell
        env:
          PYTHONUTF8: "1"
        run: |
          # Creiamo il file .env con i nomi esatti che il bot si aspetta
          $content = @(
            "KRAKEN_API_KEY=${{ secrets.KRAKEN_API_KEY }}",
            "KRAKEN_API_SECRET=${{ secrets.KRAKEN_API_SECRET }}", # Corretto da KRAKEN_SECRET_KEY
            "TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}",
            "TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}",
            "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}"
          )

          $utf8NoBom = New-Object System.Text.UTF8Encoding $false
          [System.IO.File]::WriteAllLines("$(Get-Location)\.env", $content, $utf8NoBom)

          Write-Host "✅ Ambiente pronto con nomi variabili sincronizzati."

          python -u start_live_simulation.py
      - name: Diagnosi Credenziali
        run: |
          python -c "import os\nfrom dotenv import load_dotenv\nprint(f'Cartella di lavoro: {os.getcwd()}')\ncheck_load = load_dotenv()\nprint(f'Esito load_dotenv: {check_load}')\napi_key = os.getenv('KRAKEN_API_KEY')\napi_secret = os.getenv('KRAKEN_API_SECRET')\nprint(f'KRAKEN_API_KEY trovata: {bool(api_key)}')\nprint(f'KRAKEN_API_SECRET trovata: {bool(api_secret)}')"
